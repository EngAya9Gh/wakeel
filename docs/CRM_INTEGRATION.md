# تكامل CRM - دليل التشغيل

## نظرة عامة

تم ربط نماذج الموقع (نموذج التواصل ونموذج صفحة الهبوط) مع نظام CRM الخارجي بطريقة **صامتة (Silent Integration)** لا تؤثر على تجربة المستخدم.

## آلية العمل

### 1. **Fire-and-Forget Pattern**
- عندما يسجل عميل في الموقع، يتم حفظ بياناته في قاعدة البيانات الخاصة بنا **أولاً**
- بعد ذلك، يتم إرسال البيانات للـ CRM **في الخلفية** دون انتظار الرد
- إذا فشل الـ CRM، **لن يتأثر العميل** ولن يرى أي رسالة خطأ

### 2. **Silent Error Handling**
- جميع الأخطاء يتم تسجيلها في الـ Console Logs فقط
- لا يتم إظهار أي رسائل خطأ للمستخدم
- العملية الأساسية (حفظ البيانات في موقعنا) تعمل دائماً

## الملفات المعنية

### 1. **CRMService.ts** (الخدمة الرئيسية)
```
/src/services/CRMService.ts
```
- يحتوي على منطق الاتصال بالـ CRM
- يستخدم `AbortSignal.timeout(5000)` لتجنب التعليق
- يسجل الأخطاء دون رفعها (throw)

### 2. **ContactService.ts** (نموذج التواصل)
```
/src/services/ContactService.ts
```
- يرسل بيانات نموذج "اتصل بنا" للـ CRM
- البيانات المرسلة: name, email, phone, subject, message, source

### 3. **LeadService.ts** (صفحة الهبوط)
```
/src/services/LeadService.ts
```
- يرسل بيانات صفحة الهبوط للـ CRM
- البيانات المرسلة: name, phone, email, source

## إعدادات البيئة

### المتغيرات المطلوبة في `.env`:

```env
# CRM Base URL (without trailing slash)
CRM_BASE_URL=https://honeydew-sheep-602146.hostingersite.com

# CRM API Key for authentication
CRM_API_KEY=JlQlzqUN1HFfeenMO5Iz8eJYMtOMxPnE772sqxJ
```

### القيم الافتراضية:
إذا لم يتم تعريف المتغيرات، سيتم استخدام القيم الموجودة في الكود مباشرة.

## البيانات المرسلة للـ CRM

### نموذج التواصل (Contact Form):
```json
{
  "name": "أحمد محمد",
  "phone": "+966501234567",
  "email": "ahmed@example.com",
  "subject": "استفسار",
  "message": "نص الرسالة",
  "source": "contact_form"
}
```

### صفحة الهبوط (Landing Page):
```json
{
  "name": "سارة أحمد",
  "phone": "+966509876543",
  "email": "sara@example.com",
  "source": "landing_page"
}
```

## مراقبة الأخطاء

### في بيئة التطوير (Development):
افتح Console في المتصفح أو Terminal وابحث عن:
```
[CRM Integration] Lead sent successfully
[CRM Integration] Failed to send lead
[CRM Integration] CRM returned non-success status
```

### في بيئة الإنتاج (Production):
استخدم أداة Logging مثل:
- **Vercel Logs** (إذا كنت تستخدم Vercel)
- **CloudWatch** (إذا كنت تستخدم AWS)
- **Sentry** (لتتبع الأخطاء)

## الأمان

### ✅ تم تطبيق:
1. **API Key في Server-Side فقط** - لا يتم إرساله للمتصفح
2. **HTTPS فقط** - جميع الطلبات مشفرة
3. **Timeout Protection** - الطلب يتوقف بعد 5 ثوانٍ
4. **No User Data Leakage** - الأخطاء لا تظهر للمستخدم

### ⚠️ ملاحظات أمنية:
- **لا تضع** `CRM_API_KEY` في الكود الذي يعمل في المتصفح (Client-Side)
- **لا تشارك** الـ API Key في GitHub أو أي مكان عام
- **استخدم** `.env.local` لتخزين المفاتيح السرية

## الاختبار

### 1. اختبار نموذج التواصل:
1. اذهب إلى `/contact`
2. املأ النموذج وأرسله
3. افتح Console وابحث عن `[CRM Integration]`
4. تحقق من قاعدة بيانات الـ CRM

### 2. اختبار صفحة الهبوط:
1. اذهب إلى `/landing`
2. املأ النموذج وأرسله
3. افتح Console وابحث عن `[CRM Integration]`
4. تحقق من قاعدة بيانات الـ CRM

### 3. اختبار فشل الـ CRM:
1. غيّر `CRM_BASE_URL` إلى رابط خاطئ
2. أرسل النموذج
3. يجب أن يعمل النموذج بشكل طبيعي
4. تحقق من Console - يجب أن ترى رسالة خطأ مسجلة فقط

## استكشاف الأخطاء

### المشكلة: "لا يتم إرسال البيانات للـ CRM"

**الحلول:**
1. تحقق من `CRM_BASE_URL` و `CRM_API_KEY` في `.env`
2. تحقق من أن الـ CRM يعمل (جرب الرابط في المتصفح)
3. افتح Console وابحث عن رسائل الخطأ
4. تحقق من أن الـ CORS مفعّل في الـ CRM

### المشكلة: "النموذج بطيء"

**الحلول:**
1. تحقق من أن `sendLeadToCRM` لا يستخدم `await` في الكود
2. تحقق من أن الـ Timeout مضبوط على 5 ثوانٍ
3. قد يكون الـ CRM بطيئاً - لكن هذا لا يجب أن يؤثر على المستخدم

### المشكلة: "بيانات مكررة في الـ CRM"

**الحل:**
- هذا متوقع - الـ CRM يسمح بتسجيل نفس الرقم أكثر من مرة
- إذا أردت منع التكرار، يجب تعديل منطق الـ CRM نفسه

## التطوير المستقبلي

### اقتراحات للتحسين:

1. **Queue System (نظام طابور)**
   - استخدام Redis أو Bull Queue لإرسال البيانات بشكل موثوق
   - إعادة المحاولة تلقائياً في حال الفشل

2. **Webhook من الـ CRM**
   - استقبال تحديثات من الـ CRM عند تغيير حالة العميل
   - مزامنة البيانات في الاتجاهين

3. **Dashboard للمراقبة**
   - عرض إحصائيات نجاح/فشل الإرسال للـ CRM
   - تنبيهات عند فشل الإرسال لفترة طويلة

4. **Retry Logic (إعادة المحاولة)**
   - إعادة المحاولة 3 مرات في حال الفشل
   - Exponential Backoff (زيادة الوقت بين كل محاولة)

## الدعم الفني

في حال واجهت أي مشكلة:
1. تحقق من Console Logs
2. تحقق من إعدادات `.env`
3. تواصل مع فريق الـ CRM للتأكد من عمل الـ API

---

**آخر تحديث:** 2026-01-24  
**الإصدار:** 1.0.0
